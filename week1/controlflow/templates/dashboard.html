<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Day 3: Control Flow for AI Systems</title>
<style>
  body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg,#667eea,#764ba2); color:#333; margin:0; padding:30px; }
  .container { max-width:900px; margin:auto; background:white; border-radius:12px; padding:25px; box-shadow:0 10px 25px rgba(0,0,0,0.1); }
  button { background:#667eea; color:white; border:none; border-radius:8px; padding:10px 18px; cursor:pointer; margin-right:10px; }
  button:hover { background:#5a6fd8; }
  textarea { width:100%; height:140px; padding:10px; border:2px solid #ddd; border-radius:8px; font-family:monospace; }
  pre { background:#f8f8f8; padding:12px; border-radius:8px; height:200px; overflow-y:auto; white-space:pre-wrap; }
  select { padding:8px; border-radius:6px; border:1px solid #ccc; margin-right:10px; }
</style>
</head>
<body>
<div class="container">
  <h2>ü§ñ Control Flow Playground (ETL Simulation)</h2>
  <p>Learn how loops & conditions automate ETL validation using realistic examples.</p>

  <div>
    <label>Choose Example:</label>
    <select id="exampleSelect">
      <option value="">-- Select Example --</option>
      <option value="ifelse">If-Else Decision</option>
      <option value="forloop">For Loop</option>
      <option value="whileloop">While Loop</option>
      <option value="nested">Nested Loop</option>
      <option value="csvreader">CSV Reader & Validator</option>
    </select>
    <button onclick="loadExample()">üì• Load Example</button>
  </div>

  <textarea id="code-input" placeholder="Type or load ETL logic here..."></textarea>
  <br><button onclick="runPlaygroundLive()">‚ñ∂ Run Code Live</button>

  <pre id="playground-live-output">üí° Output will appear here...</pre>
</div>

<script>
const examples = {
  ifelse: `record = {"id": 101, "amount": 950, "currency": "USD"}

if record["amount"] > 1000:
    print("üö® High value transaction detected:", record)
elif record["amount"] >= 500:
    print("‚úÖ Medium value transaction:", record)
else:
    print("üßæ Normal transaction:", record)`,

  forloop: `transactions = [120, 450, 800, 1500, 300]
valid_count = 0
for t in transactions:
    if t >= 500:
        print("‚úîÔ∏è Valid transaction:", t)
        valid_count += 1
    else:
        print("‚ùå Rejected transaction:", t)
print("‚úÖ Total valid:", valid_count, "of", len(transactions))`,

  whileloop: `total_records = 12
processed = 0
while processed < total_records:
    processed += 3
    print(f"üîÑ Processing next batch... ({processed}/{total_records})")
print("üéØ ETL processing complete!")`,

  nested: `batches = [
    [{"id": 1, "value": 500}, {"id": 2, "value": 300}],
    [{"id": 3, "value": 700}, {"id": 4, "value": 1200}]
]
for b_i, batch in enumerate(batches, 1):
    print(f"üì¶ Batch {b_i} started...")
    for rec in batch:
        if rec["value"] >= 500:
            print(f"   ‚úÖ Record {rec['id']} validated")
        else:
            print(f"   ‚ö†Ô∏è Record {rec['id']} failed validation")
    print(f"üì¶ Batch {b_i} done.\\n")
print("üèÅ All ETL batches processed successfully!")`,

  csvreader: `import csv
from io import StringIO
csv_data = """id,amount,currency
1,1200,USD
2,450,EUR
3,800,USD
4,1500,GBP
5,300,USD"""
f = StringIO(csv_data)
reader = csv.DictReader(f)
valid_rows = 0
print("üì• Reading CSV data...")
for row in reader:
    amt = int(row["amount"])
    if amt >= 500:
        print(f"‚úÖ Valid row: id={row['id']} amount={amt} {row['currency']}")
        valid_rows += 1
    else:
        print(f"‚ùå Invalid row: id={row['id']} amount={amt} {row['currency']}")
print(f"üèÅ Finished CSV processing. {valid_rows} valid rows out of 5.")`
};

function loadExample() {
  const val = document.getElementById("exampleSelect").value;
  const textarea = document.getElementById("code-input");
  textarea.value = val ? examples[val] : "";
}

function runPlaygroundLive() {
  const code = document.getElementById("code-input").value.trim();
  const out = document.getElementById("playground-live-output");
  out.textContent = "‚è≥ Running your code...\n";
  if (!code) { out.textContent = "‚ö†Ô∏è Please select or enter code."; return; }

  fetch("/api/playground/stream", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ code })
  }).then(r => {
    const reader = r.body.getReader();
    const dec = new TextDecoder();
    const read = () => reader.read().then(({done, value}) => {
      if (done) return;
      const chunk = dec.decode(value);
      chunk.split("\\n\\n").forEach(line => {
        if (line.startsWith("data: ")) {
          const msg = line.replace("data: ", "");
          out.textContent += msg + "\\n";
          out.scrollTop = out.scrollHeight;
        }
      });
      read();
    });
    read();
  });
}
</script>
</body>
</html>
